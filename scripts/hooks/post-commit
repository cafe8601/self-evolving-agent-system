#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Post-Commit Hook - ì»¤ë°‹ í›„ ìžë™ í•™ìŠµ íŠ¸ë¦¬ê±°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
BRAIN_FILE="$PROJECT_ROOT/.opencode/brain/project_brain.yaml"
CONFIG_FILE="$PROJECT_ROOT/.opencode/automation-config.yaml"

echo "ðŸ§  [Post-Commit] Starting auto-learning process..."

# ìžë™ í•™ìŠµ í™œì„±í™” ì²´í¬
AUTO_LEARN_ENABLED=true
if [[ -f "$CONFIG_FILE" ]]; then
    AUTO_LEARN_ENABLED=$(grep "auto_learn_on_commit:" "$CONFIG_FILE" | awk '{print $2}' 2>/dev/null || echo "true")
fi

if [[ "$AUTO_LEARN_ENABLED" != "true" ]]; then
    echo "   Auto-learning disabled in config"
    exit 0
fi

# ì»¤ë°‹ ì •ë³´ ì¶”ì¶œ
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
COMMIT_AUTHOR=$(git log -1 --pretty=%an)
COMMIT_DATE=$(git log -1 --pretty=%ci)

echo "   Commit: ${COMMIT_HASH:0:8}"
echo "   Author: $COMMIT_AUTHOR"
echo "   Files changed: $(echo "$COMMIT_FILES" | wc -l)"

# ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ íƒœê·¸ ì¶”ì¶œ
TAGS=""
if [[ "$COMMIT_MSG" == *"fix"* ]] || [[ "$COMMIT_MSG" == *"bug"* ]]; then
    TAGS="bugfix"
fi
if [[ "$COMMIT_MSG" == *"feat"* ]] || [[ "$COMMIT_MSG" == *"feature"* ]]; then
    TAGS="$TAGS feature"
fi
if [[ "$COMMIT_MSG" == *"refactor"* ]]; then
    TAGS="$TAGS refactor"
fi
if [[ "$COMMIT_MSG" == *"test"* ]]; then
    TAGS="$TAGS testing"
fi

# í•™ìŠµ ë¡œê·¸ ê¸°ë¡
LOG_DIR="$PROJECT_ROOT/.opencode/logs"
mkdir -p "$LOG_DIR"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

cat > "$LOG_DIR/commit_$TIMESTAMP.json" << EOF
{
    "timestamp": "$(date -Iseconds)",
    "commit_hash": "$COMMIT_HASH",
    "commit_message": $(echo "$COMMIT_MSG" | head -1 | jq -Rs .),
    "files_changed": $(echo "$COMMIT_FILES" | jq -Rs 'split("\n") | map(select(length > 0))'),
    "author": "$COMMIT_AUTHOR",
    "tags": "$(echo $TAGS | xargs)",
    "auto_learned": true
}
EOF

# Brain ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
if [[ -f "$BRAIN_FILE" ]]; then
    # last_sync ì—…ë°ì´íŠ¸
    sed -i "s/last_sync:.*/last_sync: \"$(date -Iseconds)\"/" "$BRAIN_FILE"

    # evolution_cycles ì¦ê°€
    CURRENT_CYCLES=$(grep "evolution_cycles:" "$BRAIN_FILE" | head -1 | awk '{print $2}')
    NEW_CYCLES=$((CURRENT_CYCLES + 1))
    sed -i "s/evolution_cycles: $CURRENT_CYCLES/evolution_cycles: $NEW_CYCLES/" "$BRAIN_FILE"

    echo "   Evolution cycles: $NEW_CYCLES"
fi

# ìžë™ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
if [[ -f "$SCRIPTS_DIR/auto-learn.sh" ]]; then
    nohup "$SCRIPTS_DIR/auto-learn.sh" \
        --commit "$COMMIT_HASH" \
        --message "$COMMIT_MSG" \
        --files "$COMMIT_FILES" \
        --tags "$TAGS" \
        > "$LOG_DIR/auto-learn_$TIMESTAMP.log" 2>&1 &
    echo "   Auto-learning started in background (PID: $!)"
fi

echo "âœ… [Post-Commit] Learning process initiated"
exit 0
