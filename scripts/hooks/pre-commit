#!/bin/bash
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Pre-Commit Hook - Ïª§Î∞ã Ï†Ñ Brain Ìå®ÌÑ¥ Ï≤¥ÌÅ¨
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
BRAIN_FILE="$PROJECT_ROOT/.opencode/brain/project_brain.yaml"

echo "üß† [Pre-Commit] Checking brain patterns..."

# Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
CHANGED_FILES=$(git diff --cached --name-only)

if [[ -z "$CHANGED_FILES" ]]; then
    echo "   No files staged for commit"
    exit 0
fi

echo "   Changed files:"
echo "$CHANGED_FILES" | sed 's/^/     - /'

# FAILURE_PATTERN Í¥ÄÎ†® ÌååÏùº Ï≤¥ÌÅ¨
if [[ -f "$BRAIN_FILE" ]]; then
    # Ïã§Ìå® Ìå®ÌÑ¥ÏóêÏÑú Í¥ÄÎ†® ÌååÏùº Ï∂îÏ∂ú
    FAILURE_FILES=$(grep -A 20 "FAILURE_PATTERN" "$BRAIN_FILE" | grep -E "^\s+- \"" | sed 's/.*"\(.*\)".*/\1/' 2>/dev/null)

    for file in $CHANGED_FILES; do
        for failure_file in $FAILURE_FILES; do
            if [[ "$file" == *"$failure_file"* ]]; then
                echo ""
                echo "‚ö†Ô∏è  WARNING: Modifying file related to FAILURE_PATTERN"
                echo "   File: $file"
                echo "   Please review learned patterns before committing"
                echo ""
                # Í≤ΩÍ≥†Îßå ÌïòÍ≥† ÏßÑÌñâ ÌóàÏö© (Ï∞®Îã®ÌïòÎ†§Î©¥ exit 1)
            fi
        done
    done
fi

# ÏΩîÎìú ÌíàÏßà Ï≤¥ÌÅ¨ (ÏÑ†ÌÉùÏ†Å)
if command -v eslint &> /dev/null; then
    JS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|ts|jsx|tsx)$' || true)
    if [[ -n "$JS_FILES" ]]; then
        echo "   Running ESLint..."
        echo "$JS_FILES" | xargs eslint --quiet || {
            echo "‚ùå ESLint errors found. Fix before committing."
            exit 1
        }
    fi
fi

echo "‚úÖ [Pre-Commit] All checks passed"
exit 0
