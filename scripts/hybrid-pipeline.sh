#!/bin/bash
# ═══════════════════════════════════════════════════════════════════
# hybrid-pipeline.sh
# 하이브리드 접근 파이프라인
# - 복잡한 기능: Claude Code 대화형 (수동)
# - 단순 반복: OpenCode/MDFlow 자동화
#
# 사용법: ./scripts/hybrid-pipeline.sh
# ═══════════════════════════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_DIR"

echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║              하이브리드 파이프라인 실행                        ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""

# ─────────────────────────────────────────────────────────────────
# Step 1: 아키텍처 설계 안내 (Claude Code - 수동)
# ─────────────────────────────────────────────────────────────────
echo "═══════════════════════════════════════════════════════════════"
echo "📐 Step 1: 아키텍처 설계 (Claude Code - 대화형)"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "복잡한 아키텍처 설계는 대화형으로 진행하세요:"
echo ""
echo "  claude"
echo "  > /evolve E-commerce 주문 시스템 전체 아키텍처 설계."
echo "  >   - 마이크로서비스 vs 모놀리식 결정"
echo "  >   - 데이터베이스 스키마 설계"
echo "  >   - API 엔드포인트 목록 정리"
echo "  >   - WebSocket 이벤트 정의"
echo ""
read -p "아키텍처 설계를 완료하셨나요? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "아키텍처 설계를 먼저 완료한 후 다시 실행하세요."
    exit 0
fi

# ─────────────────────────────────────────────────────────────────
# Step 2: CRUD 기능 자동 생성 (OpenCode)
# ─────────────────────────────────────────────────────────────────
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "🔨 Step 2: CRUD 기능 자동 생성 (OpenCode)"
echo "═══════════════════════════════════════════════════════════════"
echo ""

ENTITIES=("User" "Product" "Category" "Cart" "Order" "Payment")
TOTAL=${#ENTITIES[@]}
CURRENT=0

for entity in "${ENTITIES[@]}"; do
    ((CURRENT++))
    echo "[$CURRENT/$TOTAL] ${entity} CRUD API 생성 중..."
    opencode run --agent main-builder "Next.js 14 + Prisma 기반 ${entity} CRUD API 구현" 2>/dev/null || echo "  ⚠️ ${entity} 생성 스킵"
    sleep 2
done

echo ""
echo "✅ CRUD 기능 자동 생성 완료!"

# ─────────────────────────────────────────────────────────────────
# Step 3: 복잡한 비즈니스 로직 안내 (Claude Code - 수동)
# ─────────────────────────────────────────────────────────────────
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "💳 Step 3: 결제 로직 구현 (Claude Code - 대화형)"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "복잡한 결제 로직은 대화형으로 진행하세요:"
echo ""
echo "  claude"
echo "  > /evolve 결제 처리 로직 구현."
echo "  >   - Toss Payments 연동"
echo "  >   - 결제 실패 시 재시도 로직"
echo "  >   - 부분 환불 처리"
echo "  >   - 정산 데이터 생성"
echo ""
read -p "결제 로직 구현을 완료하셨나요? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "결제 로직 구현을 완료한 후 다시 실행하세요."
    exit 0
fi

# ─────────────────────────────────────────────────────────────────
# Step 4: 보안 리뷰 (MDFlow)
# ─────────────────────────────────────────────────────────────────
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "🔒 Step 4: 보안 리뷰 (MDFlow 워크플로우)"
echo "═══════════════════════════════════════════════════════════════"
echo ""

echo "전체 코드베이스 보안 리뷰: OWASP Top 10, SQL Injection, XSS 점검" | md .mdflow/review.claude.md

echo ""
echo "✅ 보안 리뷰 완료!"

# ─────────────────────────────────────────────────────────────────
# Step 5: 테스트 생성 (OpenCode)
# ─────────────────────────────────────────────────────────────────
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "🧪 Step 5: 테스트 생성 (OpenCode)"
echo "═══════════════════════════════════════════════════════════════"
echo ""

opencode run --agent main-builder "Jest + Playwright 기반 E2E 테스트 작성. 결제 플로우, 재고 동기화 시나리오" 2>/dev/null || echo "⚠️ 테스트 생성 스킵"

echo ""
echo "✅ 테스트 생성 완료!"

# ─────────────────────────────────────────────────────────────────
# Step 6: 학습 캡처
# ─────────────────────────────────────────────────────────────────
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "📚 Step 6: 학습 캡처"
echo "═══════════════════════════════════════════════════════════════"
echo ""

npm run learn:success "E-commerce 파이프라인" "하이브리드 파이프라인 완료 - CRUD 자동화 + 결제 로직 수동" 2>/dev/null || true
npm run brain:sync 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────
# 최종 결과
# ─────────────────────────────────────────────────────────────────
echo ""
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║                    ✅ 하이브리드 파이프라인 완료!              ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""
echo "완료된 작업:"
echo "  ✅ 아키텍처 설계 (Claude Code - 대화형)"
echo "  ✅ CRUD API 생성 (OpenCode - 자동화)"
echo "  ✅ 결제 로직 구현 (Claude Code - 대화형)"
echo "  ✅ 보안 리뷰 (MDFlow - 워크플로우)"
echo "  ✅ 테스트 생성 (OpenCode - 자동화)"
echo "  ✅ 학습 캡처 (Brain 동기화)"
