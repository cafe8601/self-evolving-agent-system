#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# crud-generator.sh
# ì—”í‹°í‹°ë³„ CRUD API ìžë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
#
# ì‚¬ìš©ë²•:
#   ./scripts/crud-generator.sh User Product Category
#   ./scripts/crud-generator.sh --all  (ê¸°ë³¸ ì—”í‹°í‹° ëª¨ë‘ ìƒì„±)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_DIR"

# ê¸°ë³¸ ì—”í‹°í‹° ëª©ë¡
DEFAULT_ENTITIES=("User" "Product" "Category" "Cart" "CartItem" "Order" "OrderItem" "Payment" "Review" "Wishlist")

show_help() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              CRUD API ìžë™ ìƒì„± ë„êµ¬                           â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ì‚¬ìš©ë²•: $0 [ì˜µì…˜] [ì—”í‹°í‹°...]"
    echo ""
    echo "ì˜µì…˜:"
    echo "  --all     ê¸°ë³¸ ì—”í‹°í‹° ëª¨ë‘ ìƒì„±"
    echo "  --list    ê¸°ë³¸ ì—”í‹°í‹° ëª©ë¡ í‘œì‹œ"
    echo "  -h        ë„ì›€ë§ í‘œì‹œ"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  $0 User Product Category"
    echo "  $0 --all"
    echo ""
    echo "ê¸°ë³¸ ì—”í‹°í‹°: ${DEFAULT_ENTITIES[*]}"
    exit 0
}

if [ -z "$1" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    show_help
fi

if [ "$1" == "--list" ]; then
    echo "ê¸°ë³¸ ì—”í‹°í‹° ëª©ë¡:"
    for entity in "${DEFAULT_ENTITIES[@]}"; do
        echo "  - $entity"
    done
    exit 0
fi

# ì—”í‹°í‹° ëª©ë¡ ê²°ì •
if [ "$1" == "--all" ]; then
    ENTITIES=("${DEFAULT_ENTITIES[@]}")
else
    ENTITIES=("$@")
fi

TOTAL=${#ENTITIES[@]}
CURRENT=0
SUCCESS=0
FAILED=0

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              CRUD API ìžë™ ìƒì„± ì‹œìž‘                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“‹ ìƒì„±í•  ì—”í‹°í‹°: ${TOTAL}ê°œ"
echo "   ${ENTITIES[*]}"
echo ""

for entity in "${ENTITIES[@]}"; do
    ((CURRENT++))
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "[$CURRENT/$TOTAL] ðŸ”¨ ${entity} CRUD API ìƒì„± ì¤‘..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    if opencode run --agent main-builder "Next.js 14 + Prisma ê¸°ë°˜ ${entity} CRUD API êµ¬í˜„. GET(list, detail), POST(create), PUT(update), DELETE(soft delete)" 2>/dev/null; then
        echo "âœ… ${entity} ìƒì„± ì™„ë£Œ!"
        ((SUCCESS++))
    else
        echo "âŒ ${entity} ìƒì„± ì‹¤íŒ¨!"
        ((FAILED++))
    fi

    # ë‹¤ìŒ ìš”ì²­ ì „ ìž ì‹œ ëŒ€ê¸°
    if [ $CURRENT -lt $TOTAL ]; then
        echo ""
        echo "â³ ë‹¤ìŒ ì—”í‹°í‹° ì²˜ë¦¬ ëŒ€ê¸° (3ì´ˆ)..."
        sleep 3
    fi
    echo ""
done

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    ðŸ“Š CRUD ìƒì„± ê²°ê³¼                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "  âœ… ì„±ê³µ: ${SUCCESS}ê°œ"
echo "  âŒ ì‹¤íŒ¨: ${FAILED}ê°œ"
echo "  ðŸ“‹ ì „ì²´: ${TOTAL}ê°œ"
echo ""

# í•™ìŠµ ê¸°ë¡
if [ $SUCCESS -gt 0 ]; then
    npm run learn:success "CRUD Generator" "${SUCCESS}ê°œ ì—”í‹°í‹° CRUD API ìžë™ ìƒì„± ì™„ë£Œ" 2>/dev/null || true
fi
